with Ada.Text_IO; use Ada.Text_IO;
with Aa.Representation;
with Aa.Validation;
with Aa.Assertion; use Aa.Assertion;
with Aa.C; use Aa.C;
with Bb.Representation;
with Bb.Validation;
with Bb.Assertion; use Bb.Assertion;
with Cc.Representation;
with Cc.Validation;
with Cc.Assertion; use Cc.Assertion;
with Cc.C; use Cc.C;
with Ee.Representation;
with Ee.Assertion; use Ee.Assertion;
with Ff.Assertion; use Ff.Assertion;
with Gg.Assertion; use Gg.Assertion;
with Simple_Variable.Representation;
with Simple_Variable.Validation;
with Simple_Variable.Assertion; use Simple_Variable.Assertion;
with Simple_Variable_Holder.Representation;
with Simple_Variable_Holder.Validation;
with Simple_Variable_Holder.Assertion; use Simple_Variable_Holder.Assertion;
with Simple_Variable_Offset.Representation;
with Simple_Variable_Offset.Validation;
with Simple_Variable_Offset.Assertion; use Simple_Variable_Offset.Assertion;
with Simple_Variable_Array.Representation;
with Simple_Variable_Array.Validation;
with Simple_Variable_Array.Assertion; use Simple_Variable_Array.Assertion;
with Simple_Variable_Array_Le.Representation;
with Simple_Variable_Array_Le.Validation;
with Simple_Variable_Array_Le.Assertion; use Simple_Variable_Array_Le.Assertion;
with Simple_Variable_Holder_Le.Representation;
with Simple_Variable_Holder_Le.Validation;
with Simple_Variable_Holder_Le.Assertion; use Simple_Variable_Holder_Le.Assertion;
with Basic_Types; use Basic_Types;
with String_Util;
with Interfaces; use Interfaces;
with Basic_Assertions; use Basic_Assertions;
with Serializer_Types; use Serializer_Types;
with Test_Enums; use Test_Enums;
with Register_Holder;

procedure Test is
   -- Helper packages:
   function Poly2bytestring is new String_Util.To_Byte_String (Poly_Type);

   -- Record definitions:
   Rh : Register_Holder.Register_T_Le with
     Volatile => True;
   A : Aa.T := (One => 4, Two => 20, Three => 101);
   A_Unpacked : Aa.U;
   A_Le : Aa.T_Le := (One => 4, Two => 20, Three => 101);
   A_Volatile : Aa.Volatile_T with
     Volatile;
   A_Atomic : Aa.Atomic_T with
     Atomic;
   A_Register : Aa.Register_T with
     Volatile_Full_Access;
   A_C : Aa.C.U_C := (One => 5, Two => 21, Three => 102);
   B : Bb.T := (Element => 8, Element2 => 9);
   B_Le : constant Bb.T_Le := (Element => 8, Element2 => 9);
   C : Cc.T := (C => Second_Enum.Yellow, A => A, B => B);
   C_Unpacked : Cc.U := (C => Second_Enum.Yellow, A => (One => 4, Two => 20, Three => 101), B => (Element => 8, Element2 => 9));
   C_C : Cc.C.U_C := (C => Second_Enum.Hola, A => (One => 5, Two => 21, Three => 102), B => (Element => 9, Element2 => 10));
   E : Ee.T_Le := (A => A_Le, B => B_Le, C => -5);
   E_Unpacked : Ee.U;
   V : Simple_Variable.T := (Length => 3, Buffer => [250, 249, 248, others => 0]);
   V2 : Simple_Variable.T := (Length => 0, Buffer => [others => 0]);
   V_Untouched : constant Simple_Variable.T := V;
   V_Filled : constant Simple_Variable.T := (Length => 3, Buffer => [250, 249, 248, others => 9]);
   V_Garbage : constant Simple_Variable.T := (Length => 255, Buffer => [250, 249, 248, others => 9]);
   Sv : Simple_Variable_Holder.T := (Random_Field => 7, Simple => (Length => 3, Buffer => [250, 249, 248, others => 0]));
   Sv2 : Simple_Variable_Holder.T := (Random_Field => 0, Simple => (Length => 0, Buffer => [others => 0]));
   Sv_Untouched : constant Simple_Variable_Holder.T := Sv;
   Sv_Filled : constant Simple_Variable_Holder.T := (Random_Field => 7, Simple => (Length => 3, Buffer => [250, 249, 248, others => 9]));
   Sv_Garbage : constant Simple_Variable_Holder.T := (Random_Field => 7, Simple => (Length => 255, Buffer => [250, 249, 248, others => 9]));
   Ov : Simple_Variable_Offset.T := (Length => 3, Buffer => [240, 239, 238, 237, others => 0]);
   Ov2 : Simple_Variable_Offset.T := (Length => 0, Buffer => [others => 0]);
   Ov_Untouched : constant Simple_Variable_Offset.T := Ov;
   Ov_Filled : constant Simple_Variable_Offset.T := (Length => 3, Buffer => [240, 239, 238, 237, others => 9]);
   Ov_Garbage : constant Simple_Variable_Offset.T := (Length => 255, Buffer => [240, 239, 238, 237, others => 9]);
   Av : Simple_Variable_Array.T := (Length => 2, Buffer => [A, A, others => (0, 19, 5)]);
   Av2 : Simple_Variable_Array.T := (Length => 2, Buffer => [others => (0, 19, 5)]);
   Av_Untouched : constant Simple_Variable_Array.T := Av;
   Av_Filled : constant Simple_Variable_Array.T := (Length => 2, Buffer => [A, A, others => (0, 20, 5)]);
   Av_Garbage : constant Simple_Variable_Array.T := (Length => 255, Buffer => [A, A, others => (0, 19, 5)]);
   Av_Le : Simple_Variable_Array_Le.T_Le := (Length => 2, Buffer => [A_Le, A_Le, others => (0, 19, 5)]);
   Av_Le2 : Simple_Variable_Array_Le.T_Le := (Length => 2, Buffer => [others => (0, 19, 5)]);
   Av_Le_Untouched : constant Simple_Variable_Array_Le.T_Le := Av_Le;
   Av_Le_Filled : constant Simple_Variable_Array_Le.T_Le := (Length => 2, Buffer => [A_Le, A_Le, others => (0, 20, 5)]);
   Av_Le_Garbage : constant Simple_Variable_Array_Le.T_Le := (Length => 255, Buffer => [A_Le, A_Le, others => (0, 19, 5)]);
   Sv_Le : Simple_Variable_Holder_Le.T_Le := (Random_Field => 7, Simple => (Length => 3, Buffer => [250, 249, 248, others => 0]));
   Sv_Le2 : Simple_Variable_Holder_Le.T_Le := (Random_Field => 0, Simple => (Length => 0, Buffer => [others => 0]));
   Sv_Le_Untouched : constant Simple_Variable_Holder_Le.T_Le := Sv_Le;
   Sv_Le_Filled : constant Simple_Variable_Holder_Le.T_Le := (Random_Field => 7, Simple => (Length => 3, Buffer => [250, 249, 248, others => 9]));
   Sv_Le_Garbage : constant Simple_Variable_Holder_Le.T_Le := (Random_Field => 7, Simple => (Length => 255, Buffer => [250, 249, 248, others => 9]));
   A2 : Aa.T;
   B2 : Bb.T;
   C2 : Cc.T;
   F_U : constant Ff.U := (One => 5, Two => 21.5, Three => 50.2345);
   F : constant Ff.T := (One => 5, Two => 21.5, Three => 50.2345);
   F_Le : constant Ff.T_Le := (One => 5, Two => 21.5, Three => 50.2345);
   G_U : constant Gg.U := (Yo => 17, F => (One => 5, Two => 21.5, Three => 50.2345));
   G : constant Gg.T := (Yo => 17, F => (One => 5, Two => 21.5, Three => 50.2345));

   -- Record array definitions:
   A_Bytes : Aa.Serialization.Byte_Array := [0 => 255, others => 0];
   B_Bytes : Bb.Serialization.Byte_Array := [others => 0];
   C_Bytes : Cc.Serialization.Byte_Array := [others => 0];
   V_Bytes : Simple_Variable.Serialization.Byte_Array := [0 => 2, others => 255];
   V_Bytes2 : Simple_Variable.Serialization.Byte_Array := [others => 0];
   V_Bytes3 : Simple_Variable.Serialization.Byte_Array := [others => 0];
   V_Bytes_Garbage : constant Simple_Variable.Serialization.Byte_Array := [others => 255];
   Sv_Bytes : Simple_Variable_Holder.Serialization.Byte_Array := [0 => 255, 1 => 2, others => 255];
   Sv_Bytes2 : Simple_Variable_Holder.Serialization.Byte_Array := [others => 0];
   Sv_Bytes3 : Simple_Variable_Holder.Serialization.Byte_Array := [others => 0];
   Sv_Bytes_Garbage : constant Simple_Variable_Holder.Serialization.Byte_Array := [others => 255];
   Ov_Bytes : Simple_Variable_Offset.Serialization.Byte_Array := [0 => 2, others => 255];
   Ov_Bytes2 : Simple_Variable_Offset.Serialization.Byte_Array := [others => 0];
   Ov_Bytes3 : Simple_Variable_Offset.Serialization.Byte_Array := [others => 0];
   Ov_Bytes_Garbage : constant Simple_Variable_Offset.Serialization.Byte_Array := [others => 255];
   Av_Bytes : Simple_Variable_Array.Serialization.Byte_Array := [0 => 2, others => 255];
   Av_Bytes2 : Simple_Variable_Array.Serialization.Byte_Array := [others => 0];
   Av_Bytes3 : Simple_Variable_Array.Serialization.Byte_Array := [others => 0];
   Av_Bytes_Garbage : constant Simple_Variable_Array.Serialization.Byte_Array := [others => 255];
   Av_Le_Bytes : Simple_Variable_Array_Le.Serialization_Le.Byte_Array := [0 => 2, others => 255];
   Av_Le_Bytes2 : Simple_Variable_Array_Le.Serialization_Le.Byte_Array := [others => 0];
   Av_Le_Bytes3 : Simple_Variable_Array_Le.Serialization_Le.Byte_Array := [others => 0];
   Av_Le_Bytes_Garbage : constant Simple_Variable_Array_Le.Serialization_Le.Byte_Array := [others => 255];
   Sv_Le_Bytes : Simple_Variable_Holder_Le.Serialization_Le.Byte_Array := [0 => 255, 1 => 2, others => 255];
   Sv_Le_Bytes2 : Simple_Variable_Holder_Le.Serialization_Le.Byte_Array := [others => 0];
   Sv_Le_Bytes3 : Simple_Variable_Holder_Le.Serialization_Le.Byte_Array := [others => 0];
   Sv_Le_Bytes_Garbage : constant Simple_Variable_Holder_Le.Serialization_Le.Byte_Array := [others => 255];

   -- Other local vars:
   Stat : Serialization_Status;
   Ignore : Unsigned_32;
   Field_Number : Unsigned_32;
   The_Size : Natural;
   V_Size : Natural;
   V_Size_Filled : Natural;
begin
   Rh := (Aa.Register_T_Le (A), Aa.Register_T_Le (A));

   Put_Line ("Printing records: ");
   Put_Line ("A:");
   Put_Line (Aa.Representation.Image (A));
   Put_Line ("B:");
   Put_Line (Bb.Representation.Image (B));
   Put_Line ("C:");
   Put_Line (Cc.Representation.Image (C));
   Put_Line ("V1:");
   Put_Line (Simple_Variable.Representation.Image (V));
   Put_Line ("V2:");
   Put_Line (Simple_Variable.Representation.Image (V2));
   Put_Line ("Vh1:");
   Put_Line (Simple_Variable_Holder.Representation.Image (Sv));
   Put_Line ("Vh2:");
   Put_Line (Simple_Variable_Holder.Representation.Image (Sv2));
   Put_Line ("Vo1:");
   Put_Line (Simple_Variable_Offset.Representation.Image (Ov));
   Put_Line ("Vo2:");
   Put_Line (Simple_Variable_Offset.Representation.Image (Ov2));
   Put_Line ("Va1:");
   Put_Line (Simple_Variable_Array.Representation.Image (Av));
   Put_Line ("Va2:");
   Put_Line (Simple_Variable_Array.Representation.Image (Av2));
   Put_Line ("Va_Le1:");
   Put_Line (Simple_Variable_Array_Le.Representation.Image (Av_Le));
   Put_Line ("Va_Le2:");
   Put_Line (Simple_Variable_Array_Le.Representation.Image (Av_Le2));
   Put_Line ("Sv_Le1:");
   Put_Line (Simple_Variable_Holder_Le.Representation.Image (Sv_Le));
   Put_Line ("Sv_Le2:");
   Put_Line (Simple_Variable_Holder_Le.Representation.Image (Sv_Le2));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Validating records: ");
   pragma Assert (Aa.Validation.Valid (A, Ignore), "A is not valid, but should be.");
   pragma Assert (Bb.Validation.Valid (B, Ignore), "B is not valid, but should be.");
   pragma Assert (Cc.Validation.Valid (C, Ignore), "C is not valid, but should be.");
   pragma Assert (Simple_Variable.Validation.Valid (V, Ignore), "V is not valid, but should be.");
   pragma Assert (Simple_Variable_Holder.Validation.Valid (Sv, Ignore), "SV is not valid, but should be.");
   pragma Assert (Simple_Variable_Offset.Validation.Valid (Ov, Ignore), "OV is not valid, but should be.");
   pragma Assert (Simple_Variable_Array.Validation.Valid (Av, Ignore), "AV is not valid, but should be.");
   pragma Assert (Simple_Variable_Array_Le.Validation.Valid (Av_Le, Ignore), "AV_LE is not valid, but should be.");
   pragma Assert (Simple_Variable_Holder_Le.Validation.Valid (Sv_Le, Ignore), "SV_LE is not valid, but should be.");
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Altering records to invalid ranges: ");
   A := Aa.Serialization.From_Byte_Array (A_Bytes);
   B := Bb.Serialization.From_Byte_Array (B_Bytes);
   C := Cc.Serialization.From_Byte_Array (C_Bytes);
   Stat := Simple_Variable.Serialization.From_Byte_Array (V, V_Bytes);
   pragma Assert (Stat = Success, "serialization failed");
   Stat := Simple_Variable_Holder.Serialization.From_Byte_Array (Sv, Sv_Bytes);
   pragma Assert (Stat = Success, "serialization failed");
   Stat := Simple_Variable_Offset.Serialization.From_Byte_Array (Ov, Ov_Bytes);
   pragma Assert (Stat = Success, "serialization failed");
   Stat := Simple_Variable_Array.Serialization.From_Byte_Array (Av, Av_Bytes);
   pragma Assert (Stat = Success, "serialization failed");
   Stat := Simple_Variable_Array_Le.Serialization_Le.From_Byte_Array (Av_Le, Av_Le_Bytes);
   pragma Assert (Stat = Success, "serialization failed");
   Stat := Simple_Variable_Holder_Le.Serialization_Le.From_Byte_Array (Sv_Le, Sv_Le_Bytes);
   pragma Assert (Stat = Success, "serialization failed");
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Validating records (expect failure): ");
   pragma Assert (not Aa.Validation.Valid (A, Field_Number), "A is valid, but should not be.");
   pragma Assert (Field_Number = 1, "A field_Number is wrong.");
   Put_Line (Poly2bytestring (Aa.Validation.Get_Field (A, Field_Number)));
   pragma Assert (Aa.Validation.Get_Field (A, Field_Number) = [0, 0, 0, 0, 255, 0, 0, 0], "A's polytype field is wrong.");
   pragma Assert (not Bb.Validation.Valid (B, Field_Number), "B is valid, but should not be.");
   pragma Assert (Field_Number = 2, "B field_Number is wrong.");
   pragma Assert (Bb.Validation.Get_Field (B, Field_Number) = [0, 0, 0, 0, 0, 0, 0, 0], "B's polytype field is wrong.");
   pragma Assert (not Cc.Validation.Valid (C, Field_Number), "C is valid, but should not be.");
   pragma Assert (Field_Number = 3, "C field_Number is wrong.");
   pragma Assert (Cc.Validation.Get_Field (C, Field_Number) = [0, 0, 0, 0, 0, 0, 0, 0], "C's polytype field is wrong.");
   pragma Assert (not Simple_Variable.Validation.Valid (V, Field_Number), "V is valid, but should not be.");
   pragma Assert (Field_Number = 2, "V field_Number is wrong.");
   Put_Line (Poly2bytestring (Simple_Variable.Validation.Get_Field (V, Field_Number)));
   pragma Assert (Simple_Variable.Validation.Get_Field (V, Field_Number) = [0, 0, 0, 0, 0, 0, 0, 0], "V's polytype field is wrong.");
   pragma Assert (not Simple_Variable_Holder.Validation.Valid (Sv, Field_Number), "V is valid, but should not be.");
   pragma Assert (Field_Number = 3, "V field_Number is wrong.");
   Put_Line (Poly2bytestring (Simple_Variable_Holder.Validation.Get_Field (Sv, Field_Number)));
   pragma Assert (Simple_Variable_Holder.Validation.Get_Field (Sv, Field_Number) = [0, 0, 0, 0, 0, 0, 0, 0], "V's polytype field is wrong.");
   pragma Assert (not Simple_Variable_Offset.Validation.Valid (Ov, Field_Number), "V is valid, but should not be.");
   pragma Assert (Field_Number = 2, "V field_Number is wrong.");
   Put_Line (Poly2bytestring (Simple_Variable_Offset.Validation.Get_Field (Ov, Field_Number)));
   pragma Assert (Simple_Variable_Offset.Validation.Get_Field (Ov, Field_Number) = [0, 0, 0, 0, 0, 0, 0, 0], "V's polytype field is wrong.");
   pragma Assert (not Simple_Variable_Array.Validation.Valid (Av, Field_Number), "V is valid, but should not be.");
   pragma Assert (Field_Number = 2, "V field_Number is wrong." & Interfaces.Unsigned_32'Image (Field_Number));
   Put_Line (Poly2bytestring (Simple_Variable_Array.Validation.Get_Field (Av, Field_Number)));
   pragma Assert (Simple_Variable_Array.Validation.Get_Field (Av, Field_Number) = [0, 0, 0, 0, 0, 0, 0, 0], "V's polytype field is wrong.");
   pragma Assert (not Simple_Variable_Array_Le.Validation.Valid (Av_Le, Field_Number), "AV_LE is valid, but should not be.");
   pragma Assert (Field_Number = 2, "AV_LE field_Number is wrong." & Interfaces.Unsigned_32'Image (Field_Number));
   Put_Line (Poly2bytestring (Simple_Variable_Array_Le.Validation.Get_Field (Av_Le, Field_Number)));
   pragma Assert (Simple_Variable_Array_Le.Validation.Get_Field (Av_Le, Field_Number) = [0, 0, 0, 0, 0, 0, 0, 0], "AV_LE's polytype field is wrong.");
   pragma Assert (not Simple_Variable_Holder_Le.Validation.Valid (Sv_Le, Field_Number), "SV_LE is valid, but should not be.");
   pragma Assert (Field_Number = 3, "SV_LE field_Number is wrong.");
   Put_Line (Poly2bytestring (Simple_Variable_Holder_Le.Validation.Get_Field (Sv_Le, Field_Number)));
   pragma Assert (Simple_Variable_Holder_Le.Validation.Get_Field (Sv_Le, Field_Number) = [0, 0, 0, 0, 0, 0, 0, 0], "SV_LE's polytype field is wrong.");
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of static sized records: ");
   A_Bytes := Aa.Serialization.To_Byte_Array (A);
   A2 := Aa.Serialization.From_Byte_Array (A_Bytes);
   Aa_Assert.Eq (A, A2);
   B_Bytes := Bb.Serialization.To_Byte_Array (B);
   B2 := Bb.Serialization.From_Byte_Array (B_Bytes);
   Bb_Assert.Eq (B, B2);
   C_Bytes := Cc.Serialization.To_Byte_Array (C);
   C2 := Cc.Serialization.From_Byte_Array (C_Bytes);
   Cc_Assert.Eq (C, C2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record: ");
   Stat := Simple_Variable.Serialized_Length (V_Untouched, V_Size);
   pragma Assert (Stat = Success, "serialization length failed");
   Stat := Simple_Variable.Serialized_Length (V_Filled, V_Size_Filled);
   pragma Assert (Stat = Success, "serialization length failed");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable.Max_Serialized_Length));
   Put_Line ("Min serialized size: " & Natural'Image (Simple_Variable.Min_Serialized_Length));
   Put_Line ("Actual serialized size: " & Natural'Image (V_Size));
   Put_Line ("V bytes before copy: " & Natural'Image (V_Size));
   Put_Line (String_Util.Bytes_To_String (V_Bytes));
   Stat := Simple_Variable.Serialization.To_Byte_Array (V_Bytes (0 .. V_Size - 1), V_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (V_Bytes));
   Stat := Simple_Variable.Serialization.From_Byte_Array (V2, V_Bytes, The_Size);
   pragma Assert (Stat = Success, "deserialization failed");
   pragma Assert (The_Size = V_Size, "deserialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V1:");
   Put_Line (Simple_Variable.Representation.To_Tuple_String (V_Untouched));
   Put_Line ("V2:");
   Put_Line (Simple_Variable.Representation.To_Tuple_String (V2));
   Simple_Variable_Assert_All.Eq (V_Untouched, V2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record (part 2): ");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable.Serialization.Max_Serialized_Length));
   Put_Line ("v serialized size: " & Natural'Image (V_Size));
   Put_Line ("V filled serialized size: " & Natural'Image (V_Size_Filled));
   pragma Assert (V_Size = V_Size_Filled, "sizes don't match");
   Stat := Simple_Variable.Serialization.To_Byte_Array (V_Bytes3 (0 .. V_Size - 1), V_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (V_Bytes3));
   Stat := Simple_Variable.Serialization.To_Byte_Array (V_Bytes2 (0 .. V_Size_Filled - 1), V_Filled, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size_Filled, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V filled bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (V_Bytes2));
   Put_Line ("V filled bytes (showing only filled):");
   Put_Line (String_Util.Bytes_To_String (V_Bytes2 (0 .. V_Size_Filled - 1)));
   Byte_Array_Assert.Eq (V_Bytes3, V_Bytes2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of deserialization of variable sized record containing garbage: ");
   Stat := Simple_Variable.Serialization.From_Byte_Array (V2, V_Bytes_Garbage, The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable.Serialization.From_Byte_Array (V2, V_Bytes (1 .. 0), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable.Serialization.From_Byte_Array (V2, V_Bytes (0 .. V_Size - 2), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of serialization of variable sized record: ");
   Stat := Simple_Variable.Serialization.To_Byte_Array (V_Bytes, V_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable.Serialized_Length (V_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization length failed");
   Put_Line ("length failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable.Serialization.To_Byte_Array (V_Bytes (1 .. 0), V_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable.Serialization.To_Byte_Array (V_Bytes (0 .. V_Size - 2), V_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record holder: ");
   Stat := Simple_Variable_Holder.Serialized_Length (Sv_Untouched, V_Size);
   pragma Assert (Stat = Success, "serialization length failed");
   Stat := Simple_Variable_Holder.Serialized_Length (Sv_Filled, V_Size_Filled);
   pragma Assert (Stat = Success, "serialization length failed");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Holder.Max_Serialized_Length));
   Put_Line ("Min serialized size: " & Natural'Image (Simple_Variable_Holder.Min_Serialized_Length));
   Put_Line ("Actual serialized size: " & Natural'Image (V_Size));
   Put_Line ("V bytes before copy: " & Natural'Image (V_Size));
   Put_Line (String_Util.Bytes_To_String (Sv_Bytes));
   Stat := Simple_Variable_Holder.Serialization.To_Byte_Array (Sv_Bytes (0 .. V_Size - 1), Sv_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Sv_Bytes));
   Stat := Simple_Variable_Holder.Serialization.From_Byte_Array (Sv2, Sv_Bytes, The_Size);
   pragma Assert (Stat = Success, "deserialization failed");
   pragma Assert (The_Size = V_Size, "deserialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("sV1:");
   Put_Line (Simple_Variable_Holder.Representation.To_Tuple_String (Sv_Untouched));
   Put_Line ("sV2:");
   Put_Line (Simple_Variable_Holder.Representation.To_Tuple_String (Sv2));
   Simple_Variable_Holder_Assert.Eq (Sv_Untouched, Sv2);
   Simple_Variable_Holder_Assert_All.Eq (Sv_Untouched, Sv2);
   Sv2.Simple.Buffer (Sv2.Simple.Buffer'First + 3 .. Sv2.Simple.Buffer'First + 10) := [others => 7];
   Put_Line ("sV1:");
   Put_Line (Simple_Variable_Holder.Representation.To_Tuple_String (Sv_Untouched));
   Put_Line ("sV2:");
   Put_Line (Simple_Variable_Holder.Representation.To_Tuple_String (Sv2));
   Simple_Variable_Holder_Assert.Eq (Sv_Untouched, Sv2);
   Simple_Variable_Holder_Assert_All.Neq (Sv_Untouched, Sv2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record (part 2): ");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Holder.Serialization.Max_Serialized_Length));
   Put_Line ("v serialized size: " & Natural'Image (V_Size));
   Put_Line ("V filled serialized size: " & Natural'Image (V_Size_Filled));
   pragma Assert (V_Size = V_Size_Filled, "sizes don't match");
   Stat := Simple_Variable_Holder.Serialization.To_Byte_Array (Sv_Bytes3 (0 .. V_Size - 1), Sv_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Sv_Bytes3));
   Stat := Simple_Variable_Holder.Serialization.To_Byte_Array (Sv_Bytes2 (0 .. V_Size_Filled - 1), Sv_Filled, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size_Filled, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V filled bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Sv_Bytes2));
   Put_Line ("V filled bytes (showing only filled):");
   Put_Line (String_Util.Bytes_To_String (Sv_Bytes2 (0 .. V_Size_Filled - 1)));
   Byte_Array_Assert.Eq (Sv_Bytes3, Sv_Bytes2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of deserialization of variable sized record containing garbage: ");
   Stat := Simple_Variable_Holder.Serialization.From_Byte_Array (Sv2, Sv_Bytes_Garbage, The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder.Serialization.From_Byte_Array (Sv2, Sv_Bytes (1 .. 0), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder.Serialization.From_Byte_Array (Sv2, Sv_Bytes (0 .. V_Size - 2), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of serialization of variable sized record: ");
   Stat := Simple_Variable_Holder.Serialization.To_Byte_Array (Sv_Bytes, Sv_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder.Serialized_Length (Sv_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization length failed");
   Put_Line ("length failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder.Serialization.To_Byte_Array (Sv_Bytes (1 .. 0), Sv_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder.Serialization.To_Byte_Array (Sv_Bytes (0 .. V_Size - 2), Sv_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record: ");
   Stat := Simple_Variable_Offset.Serialized_Length (Ov_Untouched, V_Size);
   pragma Assert (Stat = Success, "serialization length failed");
   Stat := Simple_Variable_Offset.Serialized_Length (Ov_Filled, V_Size_Filled);
   pragma Assert (Stat = Success, "serialization length failed");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Offset.Max_Serialized_Length));
   Put_Line ("Min serialized size: " & Natural'Image (Simple_Variable_Offset.Min_Serialized_Length));
   Put_Line ("Actual serialized size: " & Natural'Image (V_Size));
   Put_Line ("V bytes before copy: " & Natural'Image (V_Size));
   Put_Line (String_Util.Bytes_To_String (Ov_Bytes));
   Stat := Simple_Variable_Offset.Serialization.To_Byte_Array (Ov_Bytes (0 .. V_Size - 1), Ov_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Ov_Bytes));
   Stat := Simple_Variable_Offset.Serialization.From_Byte_Array (Ov2, Ov_Bytes, The_Size);
   pragma Assert (Stat = Success, "deserialization failed");
   pragma Assert (The_Size = V_Size, "deserialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V1:");
   Put_Line (Simple_Variable_Offset.Representation.To_Tuple_String (Ov_Untouched));
   Put_Line ("V2:");
   Put_Line (Simple_Variable_Offset.Representation.To_Tuple_String (Ov2));
   Simple_Variable_Offset_Assert_All.Eq (Ov_Untouched, Ov2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record (part 2): ");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Offset.Serialization.Max_Serialized_Length));
   Put_Line ("v serialized size: " & Natural'Image (V_Size));
   Put_Line ("V filled serialized size: " & Natural'Image (V_Size_Filled));
   pragma Assert (V_Size = V_Size_Filled, "sizes don't match");
   Stat := Simple_Variable_Offset.Serialization.To_Byte_Array (Ov_Bytes3 (0 .. V_Size - 1), Ov_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Ov_Bytes3));
   Stat := Simple_Variable_Offset.Serialization.To_Byte_Array (Ov_Bytes2 (0 .. V_Size_Filled - 1), Ov_Filled, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size_Filled, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V filled bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Ov_Bytes2));
   Put_Line ("V filled bytes (showing only filled):");
   Put_Line (String_Util.Bytes_To_String (Ov_Bytes2 (0 .. V_Size_Filled - 1)));
   Byte_Array_Assert.Eq (Ov_Bytes3, Ov_Bytes2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of deserialization of variable sized record containing garbage: ");
   Stat := Simple_Variable_Offset.Serialization.From_Byte_Array (Ov2, Ov_Bytes_Garbage, The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Offset.Serialization.From_Byte_Array (Ov2, Ov_Bytes (1 .. 0), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Offset.Serialization.From_Byte_Array (Ov2, Ov_Bytes (0 .. V_Size - 2), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of serialization of variable sized record: ");
   Stat := Simple_Variable_Offset.Serialization.To_Byte_Array (Ov_Bytes, Ov_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Offset.Serialized_Length (Ov_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization length failed");
   Put_Line ("length failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Offset.Serialization.To_Byte_Array (Ov_Bytes (1 .. 0), Ov_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Offset.Serialization.To_Byte_Array (Ov_Bytes (0 .. V_Size - 2), Ov_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record: ");
   Stat := Simple_Variable_Array.Serialized_Length (Av_Untouched, V_Size);
   pragma Assert (Stat = Success, "serialization length failed");
   Stat := Simple_Variable_Array.Serialized_Length (Av_Filled, V_Size_Filled);
   pragma Assert (Stat = Success, "serialization length failed");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Array.Max_Serialized_Length));
   Put_Line ("Min serialized size: " & Natural'Image (Simple_Variable_Array.Min_Serialized_Length));
   Put_Line ("Actual serialized size: " & Natural'Image (V_Size));
   Put_Line ("V bytes before copy: " & Natural'Image (V_Size));
   Put_Line (String_Util.Bytes_To_String (Av_Bytes));
   Stat := Simple_Variable_Array.Serialization.To_Byte_Array (Av_Bytes (0 .. V_Size - 1), Av_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Av_Bytes));
   Stat := Simple_Variable_Array.Serialization.From_Byte_Array (Av2, Av_Bytes, The_Size);
   pragma Assert (Stat = Success, "deserialization failed");
   pragma Assert (The_Size = V_Size, "deserialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V1:");
   Put_Line (Simple_Variable_Array.Representation.To_Tuple_String (Av_Untouched));
   Put_Line ("V2:");
   Put_Line (Simple_Variable_Array.Representation.To_Tuple_String (Av2));
   Simple_Variable_Array_Assert_All.Eq (Av_Untouched, Av2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record (part 2): ");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Array.Serialization.Max_Serialized_Length));
   Put_Line ("v serialized size: " & Natural'Image (V_Size));
   Put_Line ("V filled serialized size: " & Natural'Image (V_Size_Filled));
   pragma Assert (V_Size = V_Size_Filled, "sizes don't match");
   Stat := Simple_Variable_Array.Serialization.To_Byte_Array (Av_Bytes3 (0 .. V_Size - 1), Av_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Av_Bytes3));
   Stat := Simple_Variable_Array.Serialization.To_Byte_Array (Av_Bytes2 (0 .. V_Size_Filled - 1), Av_Filled, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size_Filled, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("V filled bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Av_Bytes2));
   Put_Line ("V filled bytes (showing only filled):");
   Put_Line (String_Util.Bytes_To_String (Av_Bytes2 (0 .. V_Size_Filled - 1)));
   Byte_Array_Assert.Eq (Av_Bytes3, Av_Bytes2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of deserialization of variable sized record containing garbage: ");
   Stat := Simple_Variable_Array.Serialization.From_Byte_Array (Av2, Av_Bytes_Garbage, The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array.Serialization.From_Byte_Array (Av2, Av_Bytes (1 .. 0), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array.Serialization.From_Byte_Array (Av2, Av_Bytes (0 .. V_Size - 2), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of serialization of variable sized record: ");
   Stat := Simple_Variable_Array.Serialization.To_Byte_Array (Av_Bytes, Av_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array.Serialized_Length (Av_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization length failed");
   Put_Line ("length failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array.Serialization.To_Byte_Array (Av_Bytes (1 .. 0), Av_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array.Serialization.To_Byte_Array (Av_Bytes (0 .. V_Size - 2), Av_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Pack/unpack test: ");
   A := (One => 4, Two => 20, Three => 101);
   A_Unpacked := Aa.Unpack (A);
   Put_Line ("A:");
   -- Put_Line (A'Image);
   Put_Line (Aa.Representation.Image (A));
   Put_Line ("A_Unpacked:");
   -- Put_Line (A_Unpacked'Image);
   Put_Line (Aa.Representation.Image (A_Unpacked));
   Aa_U_Assert.Eq (A_Unpacked, (One => 4, Two => 20, Three => 101));
   A := Aa.Pack (A_Unpacked);
   Put_Line ("A:");
   Put_Line (Aa.Representation.Image (A));
   Aa_Assert.Eq (A, (One => 4, Two => 20, Three => 101));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Swap endianness:");
   A_Le := Aa.Swap_Endianness (A);
   Put_Line ("A_Le:");
   Put_Line (Aa.Representation.Image (A_Le));
   Aa_Le_Assert.Eq (A_Le, (One => 4, Two => 20, Three => 101));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Pack/unpack test (nested): ");
   E_Unpacked := Ee.Unpack (E);
   Put_Line ("E:");
   Put_Line (Ee.Representation.Image (E));
   Put_Line ("E_Unpacked:");
   Put_Line (Ee.Representation.Image (E_Unpacked));
   Ee_U_Assert.Eq (E_Unpacked, (A => (One => 4, Two => 20, Three => 101), B => (Element => 8, Element2 => 9), C => -5));
   E := Ee.Pack (E_Unpacked);
   Put_Line ("E:");
   Put_Line (Ee.Representation.Image (E));
   Ee_Le_Assert.Eq (E, (A => (One => 4, Two => 20, Three => 101), B => (Element => 8, Element2 => 9), C => -5));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Volatile conversion test: ");
   A := (One => 4, Two => 20, Three => 101);
   A_Volatile := Aa.Volatile_T (A);
   Put_Line ("A:");
   Put_Line (Aa.Representation.Image (A));
   Put_Line (Aa.Representation.Image (Aa.T (A_Volatile)));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Atomic conversion test: ");
   A := (One => 4, Two => 20, Three => 101);
   A_Atomic := Aa.Atomic_T (A);
   Put_Line ("A:");
   Put_Line (Aa.Representation.Image (A));
   Put_Line (Aa.Representation.Image (Aa.T (A_Atomic)));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Register conversion test: ");
   A := (One => 4, Two => 20, Three => 101);
   A_Register := Aa.Register_T (A);
   Put_Line ("A:");
   Put_Line (Aa.Representation.Image (A));
   Put_Line (Aa.Representation.Image (Aa.T (A_Register)));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Endianness test: ");
   A := (One => 1, Two => 20, Three => 101);
   Put_Line (Aa.Representation.Image (A));
   A_Le := (One => 1, Two => 20, Three => 101);
   Put_Line (Aa.Representation.Image (A_Le));
   Put_Line ("");

   -- Do a conversion:
   A_Le := (One => 14, Two => 88, Three => 111);
   Put_Line (Aa.Representation.Image (A_Le));
   A := Aa.T (A_Le);
   Put_Line (Aa.Representation.Image (A));
   Put_Line ("");

   A := (One => 12, Two => 85, Three => 102);
   Put_Line (Aa.Representation.Image (A));
   A_Le := Aa.T_Le (A);
   Put_Line (Aa.Representation.Image (A_Le));

   Aa_Le_Assert.Eq (A_Le, A_Le);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("C conversion test: ");
   A_Unpacked := (One => 4, Two => 20, Three => 101);
   A_C := To_C (A_Unpacked);
   Put_Line ("A_Unpacked:");
   Put_Line (Aa.Representation.Image (A_Unpacked));
   Put_Line ("A_C:");
   Put_Line (A_C'Image);
   A_C := (One => 5, Two => 21, Three => 102);
   A_Unpacked := To_Ada (A_C);
   Put_Line ("A_Unpacked:");
   Put_Line (Aa.Representation.Image (A_Unpacked));
   Put_Line ("A_C:");
   Put_Line (A_C'Image);
   Aa_U_Assert.Eq (A_Unpacked, (One => 5, Two => 21, Three => 102));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("C conversion test 2: ");
   C_Unpacked := (C => Second_Enum.Yellow, A => (One => 4, Two => 20, Three => 101), B => (Element => 8, Element2 => 9));
   C_C := To_C (C_Unpacked);
   Put_Line ("C_Unpacked:");
   Put_Line (Cc.Representation.Image (C_Unpacked));
   Put_Line ("C_C:");
   Put_Line (C_C'Image);
   C_C := (C => Second_Enum.Hola, A => (One => 5, Two => 21, Three => 102), B => (Element => 9, Element2 => 10));
   C_Unpacked := To_Ada (C_C);
   Put_Line ("C_Unpacked:");
   Put_Line (Cc.Representation.Image (C_Unpacked));
   Put_Line ("C_C:");
   Put_Line (C_C'Image);
   Cc_U_Assert.Eq (C_Unpacked, (C => Second_Enum.Hola, A => (One => 5, Two => 21, Three => 102), B => (Element => 9, Element2 => 10)));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record LE: ");
   Stat := Simple_Variable_Array_Le.Serialized_Length_Le (Av_Le_Untouched, V_Size);
   pragma Assert (Stat = Success, "serialization length failed");
   Stat := Simple_Variable_Array_Le.Serialized_Length_Le (Av_Le_Filled, V_Size_Filled);
   pragma Assert (Stat = Success, "serialization length failed");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Array_Le.Max_Serialized_Length));
   Put_Line ("Min serialized size: " & Natural'Image (Simple_Variable_Array_Le.Min_Serialized_Length));
   Put_Line ("Actual serialized size: " & Natural'Image (V_Size));
   Put_Line ("AV_LE bytes before copy: " & Natural'Image (V_Size));
   Put_Line (String_Util.Bytes_To_String (Av_Le_Bytes));
   Stat := Simple_Variable_Array_Le.Serialization_Le.To_Byte_Array (Av_Le_Bytes (0 .. V_Size - 1), Av_Le_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("AV_LE bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Av_Le_Bytes));
   Stat := Simple_Variable_Array_Le.Serialization_Le.From_Byte_Array (Av_Le2, Av_Le_Bytes, The_Size);
   pragma Assert (Stat = Success, "deserialization failed");
   pragma Assert (The_Size = V_Size, "deserialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("AV_LE1:");
   Put_Line (Simple_Variable_Array_Le.Representation.To_Tuple_String (Av_Le_Untouched));
   Put_Line ("AV_LE2:");
   Put_Line (Simple_Variable_Array_Le.Representation.To_Tuple_String (Av_Le2));
   Simple_Variable_Array_Le_Le_Assert_All.Eq (Av_Le_Untouched, Av_Le2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record LE (part 2): ");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Array_Le.Serialization_Le.Max_Serialized_Length));
   Put_Line ("av_le serialized size: " & Natural'Image (V_Size));
   Put_Line ("AV_LE filled serialized size: " & Natural'Image (V_Size_Filled));
   pragma Assert (V_Size = V_Size_Filled, "sizes don't match");
   Stat := Simple_Variable_Array_Le.Serialization_Le.To_Byte_Array (Av_Le_Bytes3 (0 .. V_Size - 1), Av_Le_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("AV_LE bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Av_Le_Bytes3));
   Stat := Simple_Variable_Array_Le.Serialization_Le.To_Byte_Array (Av_Le_Bytes2 (0 .. V_Size_Filled - 1), Av_Le_Filled, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size_Filled, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("AV_LE filled bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Av_Le_Bytes2));
   Put_Line ("AV_LE filled bytes (showing only filled):");
   Put_Line (String_Util.Bytes_To_String (Av_Le_Bytes2 (0 .. V_Size_Filled - 1)));
   Byte_Array_Assert.Eq (Av_Le_Bytes3, Av_Le_Bytes2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of deserialization of variable sized record LE containing garbage: ");
   Stat := Simple_Variable_Array_Le.Serialization_Le.From_Byte_Array (Av_Le2, Av_Le_Bytes_Garbage, The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array_Le.Serialization_Le.From_Byte_Array (Av_Le2, Av_Le_Bytes (1 .. 0), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array_Le.Serialization_Le.From_Byte_Array (Av_Le2, Av_Le_Bytes (0 .. V_Size - 2), The_Size);
   pragma Unreferenced (Av_Le2);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of serialization of variable sized record LE: ");
   Stat := Simple_Variable_Array_Le.Serialization_Le.To_Byte_Array (Av_Le_Bytes, Av_Le_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array_Le.Serialized_Length_Le (Av_Le_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization length failed");
   Put_Line ("length failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array_Le.Serialization_Le.To_Byte_Array (Av_Le_Bytes (1 .. 0), Av_Le_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Array_Le.Serialization_Le.To_Byte_Array (Av_Le_Bytes (0 .. V_Size - 2), Av_Le_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record holder LE: ");
   Stat := Simple_Variable_Holder_Le.Serialized_Length_Le (Sv_Le_Untouched, V_Size);
   pragma Assert (Stat = Success, "serialization length failed");
   Stat := Simple_Variable_Holder_Le.Serialized_Length_Le (Sv_Le_Filled, V_Size_Filled);
   pragma Assert (Stat = Success, "serialization length failed");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Holder_Le.Max_Serialized_Length));
   Put_Line ("Min serialized size: " & Natural'Image (Simple_Variable_Holder_Le.Min_Serialized_Length));
   Put_Line ("Actual serialized size: " & Natural'Image (V_Size));
   Put_Line ("SV_LE bytes before copy: " & Natural'Image (V_Size));
   Put_Line (String_Util.Bytes_To_String (Sv_Le_Bytes));
   Stat := Simple_Variable_Holder_Le.Serialization_Le.To_Byte_Array (Sv_Le_Bytes (0 .. V_Size - 1), Sv_Le_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("SV_LE bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Sv_Le_Bytes));
   Stat := Simple_Variable_Holder_Le.Serialization_Le.From_Byte_Array (Sv_Le2, Sv_Le_Bytes, The_Size);
   pragma Assert (Stat = Success, "deserialization failed");
   pragma Assert (The_Size = V_Size, "deserialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("SV_LE1:");
   Put_Line (Simple_Variable_Holder_Le.Representation.To_Tuple_String (Sv_Le_Untouched));
   Put_Line ("SV_LE2:");
   Put_Line (Simple_Variable_Holder_Le.Representation.To_Tuple_String (Sv_Le2));
   Simple_Variable_Holder_Le_Le_Assert.Eq (Sv_Le_Untouched, Sv_Le2);
   Simple_Variable_Holder_Le_Le_Assert_All.Eq (Sv_Le_Untouched, Sv_Le2);
   Sv_Le2.Simple.Buffer (Sv_Le2.Simple.Buffer'First + 3 .. Sv_Le2.Simple.Buffer'First + 10) := [others => 7];
   Put_Line ("SV_LE1:");
   Put_Line (Simple_Variable_Holder_Le.Representation.To_Tuple_String (Sv_Le_Untouched));
   Put_Line ("SV_LE2:");
   Put_Line (Simple_Variable_Holder_Le.Representation.To_Tuple_String (Sv_Le2));
   Simple_Variable_Holder_Le_Le_Assert.Eq (Sv_Le_Untouched, Sv_Le2);
   Simple_Variable_Holder_Le_Le_Assert_All.Neq (Sv_Le_Untouched, Sv_Le2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing serialization/deserialization of variable sized record holder LE (part 2): ");
   Put_Line ("Max serialized size: " & Natural'Image (Simple_Variable_Holder_Le.Serialization_Le.Max_Serialized_Length));
   Put_Line ("sv_le serialized size: " & Natural'Image (V_Size));
   Put_Line ("SV_LE filled serialized size: " & Natural'Image (V_Size_Filled));
   pragma Assert (V_Size = V_Size_Filled, "sizes don't match");
   Stat := Simple_Variable_Holder_Le.Serialization_Le.To_Byte_Array (Sv_Le_Bytes3 (0 .. V_Size - 1), Sv_Le_Untouched, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("SV_LE bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Sv_Le_Bytes3));
   Stat := Simple_Variable_Holder_Le.Serialization_Le.To_Byte_Array (Sv_Le_Bytes2 (0 .. V_Size_Filled - 1), Sv_Le_Filled, The_Size);
   pragma Assert (Stat = Success, "serialization failed");
   pragma Assert (The_Size = V_Size_Filled, "serialization produces wrong size: " & Natural'Image (The_Size));
   Put_Line ("SV_LE filled bytes after copy:");
   Put_Line (String_Util.Bytes_To_String (Sv_Le_Bytes2));
   Put_Line ("SV_LE filled bytes (showing only filled):");
   Put_Line (String_Util.Bytes_To_String (Sv_Le_Bytes2 (0 .. V_Size_Filled - 1)));
   Byte_Array_Assert.Eq (Sv_Le_Bytes3, Sv_Le_Bytes2);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of deserialization of variable sized record holder LE containing garbage: ");
   Stat := Simple_Variable_Holder_Le.Serialization_Le.From_Byte_Array (Sv_Le2, Sv_Le_Bytes_Garbage, The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder_Le.Serialization_Le.From_Byte_Array (Sv_Le2, Sv_Le_Bytes (1 .. 0), The_Size);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder_Le.Serialization_Le.From_Byte_Array (Sv_Le2, Sv_Le_Bytes (0 .. V_Size - 2), The_Size);
   pragma Unreferenced (Sv_Le2);
   pragma Assert (Stat = Failure, "deserialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing error handling of serialization of variable sized record holder LE: ");
   Stat := Simple_Variable_Holder_Le.Serialization_Le.To_Byte_Array (Sv_Le_Bytes, Sv_Le_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder_Le.Serialized_Length_Le (Sv_Le_Garbage, The_Size);
   pragma Assert (Stat = Failure, "serialization length failed");
   Put_Line ("length failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder_Le.Serialization_Le.To_Byte_Array (Sv_Le_Bytes (1 .. 0), Sv_Le_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Stat := Simple_Variable_Holder_Le.Serialization_Le.To_Byte_Array (Sv_Le_Bytes (0 .. V_Size - 2), Sv_Le_Untouched, The_Size);
   pragma Assert (Stat = Failure, "serialization succeeded but was expected to fail.");
   Put_Line ("failed at byte: " & Natural'Image (The_Size));
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Floating point assertion test: ");
   Ff_U_Assert.Eq (F_U, (5, 15.2, 45.3), Epsilon => 50.0);
   Ff_Assert.Eq (F, (5, 15.2, 45.3), Epsilon => 50.0);
   Ff_Le_Assert.Eq (F_Le, (5, 15.2, 45.3), Epsilon => 50.0);
   Ff_U_Assert.Eq (F_U, (5, 21.5, 50.2), Epsilon => 0.1);
   Ff_Assert.Eq (F, (5, 21.5, 50.2), Epsilon => 0.1);
   Ff_Le_Assert.Eq (F_Le, (5, 21.5, 50.2), Epsilon => 0.1);
   Gg_U_Assert.Eq (G_U, (17, (5, 15.2, 45.3)), Epsilon => 50.0);
   Gg_Assert.Eq (G, (17, (5, 15.2, 45.3)), Epsilon => 50.0);
   Gg_U_Assert.Eq (G_U, (17, (5, 21.5, 50.2)), Epsilon => 0.1);
   Gg_Assert.Eq (G, (17, (5, 21.5, 50.2)), Epsilon => 0.1);
   Put_Line ("passed.");
   Put_Line ("");

   Put_Line ("Testing Word_Serializer for packed records: ");
   Put_Line ("Testing native endianness word serialization...");
   declare
      A_Test : constant Aa.T := (One => 10, Two => 100, Three => 1023);
      Words : Aa.Word_Serialization.Word_Array;
      A_Result : Aa.T;
   begin
      -- Test function form:
      Words := Aa.Word_Serialization.To_Word_Array (A_Test);
      pragma Assert (Words'Length = Aa.Word_Serialization.Serialized_Length, "Word array length incorrect");
      Put_Line ("Word array length: " & Natural'Image (Words'Length));

      -- Convert back and verify:
      A_Result := Aa.Word_Serialization.From_Word_Array (Words);
      Aa_Assert.Eq (A_Result, A_Test);

      -- Test procedure form:
      Aa.Word_Serialization.To_Word_Array (Words, A_Test);
      Aa.Word_Serialization.From_Word_Array (A_Result, Words);
      Aa_Assert.Eq (A_Result, A_Test);

      Put_Line ("Native endianness word serialization passed.");
   end;

   Put_Line ("Testing little-endian word serialization...");
   declare
      A_Le_Test : constant Aa.T_Le := (One => 15, Two => 128, Three => 512);
      Words_Le : Aa.Word_Serialization_Le.Word_Array_Le;
      A_Le_Result : Aa.T_Le;
   begin
      -- Test function form:
      Words_Le := Aa.Word_Serialization_Le.To_Word_Array_Le (A_Le_Test);
      pragma Assert (Words_Le'Length = Aa.Word_Serialization_Le.Serialized_Length, "Word_Le array length incorrect");

      -- Convert back and verify:
      A_Le_Result := Aa.Word_Serialization_Le.From_Word_Array_Le (Words_Le);
      Aa_Le_Assert.Eq (A_Le_Result, A_Le_Test);

      -- Test procedure form:
      Aa.Word_Serialization_Le.To_Word_Array_Le (Words_Le, A_Le_Test);
      Aa.Word_Serialization_Le.From_Word_Array_Le (A_Le_Result, Words_Le);
      Aa_Le_Assert.Eq (A_Le_Result, A_Le_Test);

      Put_Line ("Little-endian word serialization passed.");
   end;

   Put_Line ("Testing big-endian word serialization...");
   declare
      A_Test : constant Aa.T := (One => 18, Two => 200, Three => 750);
      Words_Be : Aa.Word_Serialization.Word_Array_Be;
      A_Result : Aa.T;
   begin
      -- Test function form:
      Words_Be := Aa.Word_Serialization.To_Word_Array_Be (A_Test);
      pragma Assert (Words_Be'Length = Aa.Word_Serialization.Serialized_Length, "Word_Be array length incorrect");

      -- Convert back and verify:
      A_Result := Aa.Word_Serialization.From_Word_Array_Be (Words_Be);
      Aa_Assert.Eq (A_Result, A_Test);

      -- Test procedure form:
      Aa.Word_Serialization.To_Word_Array_Be (Words_Be, A_Test);
      Aa.Word_Serialization.From_Word_Array_Be (A_Result, Words_Be);
      Aa_Assert.Eq (A_Result, A_Test);

      Put_Line ("Big-endian word serialization passed.");
   end;

   Put_Line ("Testing word serialization round-trip consistency...");
   declare
      A_Original : constant Aa.T := (One => 12, Two => 45, Three => 678);
      Words_Native : Aa.Word_Serialization.Word_Array;
      Words_Le : Aa.Word_Serialization.Word_Array_Le;
      Words_Be : Aa.Word_Serialization.Word_Array_Be;
      A_From_Native : Aa.T;
      A_From_Le : Aa.T;
      A_From_Be : Aa.T;
   begin
      -- Convert to all three word array formats:
      Words_Native := Aa.Word_Serialization.To_Word_Array (A_Original);
      Words_Le := Aa.Word_Serialization.To_Word_Array_Le (A_Original);
      Words_Be := Aa.Word_Serialization.To_Word_Array_Be (A_Original);

      -- Convert back from all three formats:
      A_From_Native := Aa.Word_Serialization.From_Word_Array (Words_Native);
      A_From_Le := Aa.Word_Serialization.From_Word_Array_Le (Words_Le);
      A_From_Be := Aa.Word_Serialization.From_Word_Array_Be (Words_Be);

      -- All should match the original:
      Aa_Assert.Eq (A_From_Native, A_Original);
      Aa_Assert.Eq (A_From_Le, A_Original);
      Aa_Assert.Eq (A_From_Be, A_Original);

      Put_Line ("Round-trip consistency verified for all endianness variants.");
   end;

   Put_Line ("All Word_Serializer tests for packed records passed!");
   Put_Line ("");
end Test;
