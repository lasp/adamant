#!/usr/bin/env python3

# Build our dependencies using the build system.
# This is necessary because some of the dependencies we
# have are autogenerated.
from util import pydep

pydep.build_py_deps()

from aa import Aa
from complex_array import Complex_Array
from eight_bit_type_array import Eight_Bit_Type_Array
from simple_array import Simple_Array
from unaligned_array import Unaligned_Array
from enum_array import Enum_Array
from float_array import Float_Array
from gg import Gg
from ff import Ff
from complex_float_array import Complex_Float_Array
from test_enums import First_Enum
from base_classes.packed_type_base import epsilon, get_epsilon
import sys


def println(strn=""):
    sys.stderr.write(strn + "\n")


# Main:
if __name__ == "__main__":
    println("testing simple:")
    println("create simple:")
    s = Simple_Array([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17])
    println(str(s))
    println(str(s.to_tuple_string()))
    println(str(s.to_byte_array().hex()))
    println(str(s.to_byte_string()))
    data = s.to_byte_array()
    println("create simple2:")
    s2 = Simple_Array()
    assert s != s2
    println(str(s2))
    println("fill simple2:")
    s2.from_byte_array(data)
    println(str(s2))
    assert s == s2
    println("passed.")
    println()

    println("testing complex:")
    println("create complex:")
    a = Aa(1, 2, 3)
    c = Complex_Array([a for idx in range(25)])
    println(str(c))
    println(str(c.to_tuple_string()))
    println(str(c.to_byte_array().hex()))
    println(str(c.to_byte_string()))
    data = c.to_byte_array()
    println("create complex2:")
    c2 = Complex_Array()
    assert c != c2
    println(str(c2))
    println("fill complex2:")
    c2.from_byte_array(data)
    println(str(c2))
    assert c == c2
    println("passed.")
    println()

    println("testing eight:")
    println("create eight:")
    yo = [1, 2, 3, 4, 5, 6, 7, 8]
    e = Eight_Bit_Type_Array([yo for idx in range(200)])
    println(str(e))
    println(str(e.to_tuple_string()))
    println(str(e.to_byte_array().hex()))
    println(str(e.to_byte_string()))
    data = e.to_byte_array()
    println("create eight2:")
    e2 = Eight_Bit_Type_Array()
    assert e != e2
    println(str(e2))
    println("fill eight2:")
    e2.from_byte_array(data)
    println(str(e2))
    assert e == e2
    println("passed.")
    println()

    println("testing unaligned:")
    println("create unaligned:")
    u = Unaligned_Array([1, 2, 3, 4, 5, 6, 7, 8])
    println(str(u))
    println(str(u.to_tuple_string()))
    println(str(u.to_byte_array().hex()))
    println(str(u.to_byte_string()))
    data = u.to_byte_array()
    println("create unaligned2:")
    u2 = Unaligned_Array()
    assert u != u2
    println(str(u2))
    println("fill unaligned2:")
    u2.from_byte_array(data)
    println(str(u2))
    assert u == u2
    println("passed.")
    println()

    println("testing enum:")
    println("create enum:")
    en = Enum_Array(
        [First_Enum(1), First_Enum(2), First_Enum(3), First_Enum(0), First_Enum(1)]
    )
    println(str(en))
    println(str(en.to_tuple_string()))
    println(str(en.to_byte_array().hex()))
    println(str(en.to_byte_string()))
    data = en.to_byte_array()
    println("create enum2:")
    en2 = Enum_Array()
    assert en != en2
    println(str(en2))
    println("fill enum2:")
    en2.from_byte_array(data)
    println(str(en2))
    assert en == en2
    println("passed.")
    println()

    println("testing float_array:")
    println("create float_array:")
    fa1 = Float_Array([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])
    println(str(fa1))
    println(str(fa1.to_tuple_string()))
    println(str(fa1.to_byte_array().hex()))
    data = fa1.to_byte_array()
    println("create float_array2 from bytes:")
    fa2 = Float_Array.create_from_byte_array(data)
    println(str(fa2))
    assert fa1 == fa2
    println("passed.")
    println()

    println("testing complex_float_array:")
    println("create complex_float_array:")
    f = Ff(One=1, Two=1.5, Three=2.5)
    g = Gg(Yo=42, F=f)
    cfa1 = Complex_Float_Array([g for idx in range(25)])
    println(str(cfa1))
    data = cfa1.to_byte_array()
    println("create complex_float_array2 from bytes:")
    cfa2 = Complex_Float_Array.create_from_byte_array(data)
    println(str(cfa2))
    assert cfa1 == cfa2
    println("passed.")
    println()

    println("testing epsilon with float_array:")
    println("default epsilon is 0.0 (exact comparison):")
    assert get_epsilon() == 0.0
    fa3 = Float_Array([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])
    fa4 = Float_Array([1.0, 2.0, 3.0000001, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])
    println(f"fa3.elements[2] = {fa3.elements[2]}")
    println(f"fa4.elements[2] = {fa4.elements[2]}")
    println("exact comparison (default): fa3 != fa4")
    assert fa3 != fa4
    println("tolerant comparison with epsilon(0.0001):")
    with epsilon(0.0001):
        assert get_epsilon() == 0.0001
        assert fa3 == fa4
        println("fa3 == fa4 within epsilon")
    println("back to exact comparison: fa3 != fa4")
    assert get_epsilon() == 0.0
    assert fa3 != fa4
    println("passed.")
    println()

    println("testing epsilon with complex_float_array:")
    f3 = Ff(One=1, Two=1.5, Three=2.5)
    f4 = Ff(One=1, Two=1.5000001, Three=2.5)
    g3 = Gg(Yo=42, F=f3)
    g4 = Gg(Yo=42, F=f4)
    cfa3 = Complex_Float_Array([g3 for idx in range(25)])
    cfa4 = Complex_Float_Array([g4 for idx in range(25)])
    println("exact comparison (default): cfa3 != cfa4")
    assert cfa3 != cfa4
    println("tolerant comparison with epsilon(0.0001):")
    with epsilon(0.0001):
        assert cfa3 == cfa4
        println("cfa3 == cfa4 within epsilon (propagates through nested types)")
    println("back to exact comparison: cfa3 != cfa4")
    assert cfa3 != cfa4
    println("passed.")
    println()

    println("testing is_equal with epsilon:")
    println("is_equal with partial comparison and epsilon:")
    fa5 = Float_Array([1.0, 2.0, 3.0, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 12.0])
    fa6 = Float_Array([1.0, 2.0, 3.0000001, 4.0, 5.0, 6.0, 7.0, 8.0, 9.0, 10.0, 11.0, 99.0])
    # Compare only first 3 elements - difference is in element 2
    assert not fa5.is_equal(fa6, num_elements_to_compare=3, epsilon=0.0)
    assert fa5.is_equal(fa6, num_elements_to_compare=3, epsilon=0.0001)
    # Compare only first 2 elements - no difference
    assert fa5.is_equal(fa6, num_elements_to_compare=2, epsilon=0.0)
    println("passed.")
    println()
